<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Fabiatster</title>
    <style>
        :root{
            --bg:#07070a;
            --panel:#141418;
            --border:rgba(255,255,255,.12);
            --text:rgba(255,255,255,.92);
            --muted:rgba(255,255,255,.65);
            --accent:#ff0033;
            --radius:18px;
        }
        *{ box-sizing:border-box }
        body{
            margin:0; min-height:100vh;
            font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
            color:var(--text);
            background: radial-gradient(900px 600px at 50% 0%, rgba(255,0,51,.14), transparent 55%), var(--bg);
            display:flex;
            justify-content:center;
        }
        .wrap{ width:min(560px,100%); padding:18px 16px 28px; }
        h1{ margin:10px 0 4px; font-weight:850; letter-spacing:-.5px; text-align:center; }
        .sub{ margin:0 0 16px; text-align:center; color:var(--muted); font-size:14px; }

        .panel{
            background:var(--panel);
            border:1px solid var(--border);
            border-radius:var(--radius);
            padding:14px;
            margin:12px 0;
        }
        .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
        button{
            padding:12px 14px;
            border-radius:14px;
            border:1px solid var(--border);
            background:rgba(255,255,255,.06);
            color:var(--text);
            font-weight:750;
            cursor:pointer;
        }
        button.primary{ background:var(--accent); border-color:var(--accent); color:#0b0c10; }
        button:disabled{ opacity:.55; cursor:not-allowed; }

        #reader{
            width:100%;
            border-radius:14px;
            overflow:hidden;
            margin-top:12px;
            display:none;
        }
        .msg{ margin-top:10px; font-size:13px; color:var(--muted); }
        .ok{ color:#b7ffcf; }
        .err{ color:#ffb3b3; }
        a{ color:var(--accent); }
    </style>
</head>

<body>
<div class="wrap">
    <h1>Fabiatster</h1>
    <p class="sub">QR scannen</p>

    <div class="panel">
        <div class="row">
            <button class="primary" id="btnStart">📷 Scanner starten</button>
            <button id="btnStop" disabled>Stop</button>
            <button id="btnTorch" disabled>🔦 Licht</button>
        </div>
        <div id="reader"></div>
        <div id="scanStatus" class="msg"></div>
    </div>
</div>

<!-- QR library -->
<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

<script>
    let scanner = null;
    let torchOn = false;

    // One-shot state
    let pendingVideoId = null;     // zuletzt gescannte ID
    let launched = false;          // wurde bereits geöffnet?
    let motionListenerAttached = false;

    const $ = (id) => document.getElementById(id);

    function extractVideoId(text){
        text = (text || "").trim();

        let m = text.match(/youtu\.be\/([a-zA-Z0-9_-]{6,})/);
        if (m) return m[1];

        m = text.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
        if (m) return m[1];

        m = text.match(/youtube\.com\/shorts\/([a-zA-Z0-9_-]{6,})/);
        if (m) return m[1];

        m = text.match(/^([a-zA-Z0-9_-]{6,})$/);
        if (m) return m[1];

        return null;
    }

    function openYouTubeMusic(videoId){
        const webUrl = `https://music.youtube.com/watch?v=${encodeURIComponent(videoId)}`;

        const ua = navigator.userAgent || "";
        const isAndroid = /Android/i.test(ua);
        const isIOS = /iPhone|iPad|iPod/i.test(ua);

        if (isAndroid){
            const intentUrl =
                `intent://music.youtube.com/watch?v=${encodeURIComponent(videoId)}` +
                `#Intent;scheme=https;package=com.google.android.apps.youtube.music;end`;

            window.location.href = intentUrl;
            setTimeout(() => { window.location.href = webUrl; }, 900);
            return;
        }

        if (isIOS){
            const appUrl = `youtube-music://watch?v=${encodeURIComponent(videoId)}`;
            window.location.href = appUrl;
            setTimeout(() => { window.location.href = webUrl; }, 900);
            return;
        }

        window.location.href = webUrl;
    }

    async function ensureMotionPermissionFromClick(){
        // Muss direkt aus einem echten Button-Click kommen (iOS)
        if (typeof DeviceMotionEvent !== "undefined" &&
            typeof DeviceMotionEvent.requestPermission === "function") {
            const res = await DeviceMotionEvent.requestPermission();
            if (res !== "granted") throw new Error("Sensor Permission verweigert");
        }
    }

    function attachMotionListenerOnce(){
        if (motionListenerAttached) return;
        motionListenerAttached = true;

        window.addEventListener("devicemotion", (e) => {
            // One-shot: erst öffnen wenn wir eine ID haben und noch nicht geöffnet wurde
            if (!pendingVideoId || launched) return;

            const g = e.accelerationIncludingGravity;
            if (!g || typeof g.z !== "number") return;

            const z = g.z;

            // ✅ Dein Wunsch: z zwischen 8 und 10 => Trigger
            if (z >= 8 && z <= 10){
                launched = true;
                $("scanStatus").innerHTML = `<span class="ok">✅ Öffne YouTube Music…</span>`;
                openYouTubeMusic(pendingVideoId);
            }
        }, { passive: true });
    }

    async function handleScanValue(decodedText){
        const id = extractVideoId(decodedText);
        if (!id){
            $("scanStatus").innerHTML = `<span class="err">Kein Video-ID erkannt.</span>`;
            return;
        }

        // Neues Scan-Ergebnis => one-shot wieder erlauben
        pendingVideoId = id;
        launched = false;

        // Optional: Scanner stoppen (damit nicht dauernd neu scannt)
        if (scanner){
            try { await scanner.stop(); } catch(e) {}
        }

        $("scanStatus").innerHTML = `
      <div style="font-size:20px;font-weight:900;margin-bottom:8px;">
        🎵 Song bereit!
      </div>
      <div style="font-size:16px;font-weight:800;margin-bottom:10px;">
        (Trigger: z zwischen 8–10)
      </div>
      <div class="msg">
        Oder manuell:
        <button class="primary" id="openBtn">Link öffnen</button>
      </div>
      <div class="msg">
        <a href="https://music.youtube.com/watch?v=${id}">Web öffnen (Fallback)</a>
      </div>
    `;

        // Manuell öffnen (immer möglich, auch wenn Sensor nicht triggert)
        const btn = document.getElementById("openBtn");
        if (btn){
            btn.addEventListener("click", () => {
                launched = true; // verhindert späteres Auto-Triggern
                openYouTubeMusic(id);
            });
        }
    }

    async function startScanner(){
        $("scanStatus").textContent = "Starte Kamera…";
        $("reader").style.display = "block";
        $("reader").innerHTML = "";

        // Beim Klick auf Scanner starten holen wir Permission & starten Motion-Listener
        // (damit iOS Popup kommt)
        await ensureMotionPermissionFromClick();
        attachMotionListenerOnce();

        scanner = new Html5Qrcode("reader");
        const config = { fps: 12, qrbox: { width: 250, height: 250 } };

        const onScanSuccess = async (decodedText) => {
            await handleScanValue(decodedText);
        };

        // Prefer back camera; fallback to first camera
        try{
            await scanner.start({ facingMode: "environment" }, config, onScanSuccess);
        }catch(e1){
            const cams = await Html5Qrcode.getCameras();
            if (!cams || cams.length === 0) throw new Error("Keine Kamera gefunden (Berechtigung?)");
            await scanner.start({ deviceId: { exact: cams[0].id } }, config, onScanSuccess);
        }

        $("btnStart").disabled = true;
        $("btnStop").disabled = false;

        // Torch availability
        try{
            const caps = await scanner.getRunningTrackCapabilities();
            $("btnTorch").disabled = !(caps && caps.torch);
        }catch(e){
            $("btnTorch").disabled = true;
        }

        $("scanStatus").textContent = "Scanner läuft. QR in die Box halten.";
    }

    async function stopScanner(){
        torchOn = false;
        $("btnTorch").textContent = "🔦 Licht";
        $("btnTorch").disabled = true;

        if (scanner){
            try{ await scanner.stop(); }catch(e){}
            try{ await scanner.clear(); }catch(e){}
            scanner = null;
        }

        // Reset state: nächster Scan soll wieder möglich sein
        pendingVideoId = null;
        launched = false;

        $("reader").style.display = "none";
        $("scanStatus").textContent = "";
        $("btnStart").disabled = false;
        $("btnStop").disabled = true;
    }

    async function toggleTorch(){
        if (!scanner) return;
        try{
            torchOn = !torchOn;
            await scanner.applyVideoConstraints({ advanced: [{ torch: torchOn }] });
            $("btnTorch").textContent = torchOn ? "🔦 Licht aus" : "🔦 Licht";
        }catch(e){
            $("scanStatus").innerHTML = `<span class="err">Licht nicht unterstützt.</span>`;
            $("btnTorch").disabled = true;
        }
    }

    // events
    $("btnStart").addEventListener("click", () => startScanner().catch(err => {
        console.error(err);
        $("scanStatus").innerHTML = `<span class="err">Start fehlgeschlagen: ${err?.message || err}</span>`;
        stopScanner();
    }));

    $("btnStop").addEventListener("click", () => stopScanner());
    $("btnTorch").addEventListener("click", () => toggleTorch());
</script>
</body>
</html>
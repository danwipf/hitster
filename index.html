<!doctype html>
<html lang="de">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hitster</title>
    <style>
        body {
            margin:0;
            font-family:system-ui;
            background:#111;
            color:white;
            display:flex;
            justify-content:center;
        }
        .wrap {
            width:100%;
            max-width:500px;
            padding:20px;
        }
        button {
            padding:12px 16px;
            border-radius:12px;
            border:none;
            font-weight:bold;
            cursor:pointer;
            margin:6px 0;
        }
        .primary { background:#1db954; color:black; }
        .panel {
            background:#1c1c1c;
            padding:15px;
            border-radius:16px;
            margin-top:15px;
        }
        img { width:80px; border-radius:12px; }
    </style>
</head>
<body>
<div class="wrap">
    <h1>Hitster</h1>
    <button class="primary" id="startBtn">Scanner starten</button>
    <div id="reader" style="margin-top:15px;"></div>

    <div id="player" class="panel" style="display:none;">
        <div style="display:flex; gap:12px; align-items:center;">
            <img id="cover">
            <div>
                <div id="title"></div>
                <div id="artist" style="opacity:.7;font-size:14px;"></div>
            </div>
        </div>
        <button class="primary" id="playBtn">▶ Play 30s</button>
        <audio id="audio"></audio>
    </div>
</div>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>


<script>
    const MAX_SECONDS = 30;
    let songs = null;

    async function loadSongs() {
        if (songs) return songs;
        const res = await fetch("songs.json");
        songs = await res.json();
        return songs;
    }

    function extractId(text) {
        const m = text.match(/track\/([a-zA-Z0-9]{22})/);
        return m ? m[1] : null;
    }

    async function startScanner() {
        const status = (msg) => console.log(msg);

        const qr = new Html5Qrcode("reader");

        // iOS/Android/Chrome: prefer back camera via constraints
        const config = { fps: 10, qrbox: 250 };

        try {
            // 1) Try: environment (rear camera)
            await qr.start(
                { facingMode: "environment" },
                config,
                async (decoded) => {
                    const id = extractId(decoded);
                    if (!id) return;

                    const db = await loadSongs();
                    const track = db[id];
                    if (!track) { alert("Song nicht in songs.json"); return; }

                    document.getElementById("player").style.display = "block";
                    document.getElementById("title").textContent = track.title;
                    document.getElementById("artist").textContent = track.artist;
                    document.getElementById("cover").src = track.cover;

                    const audio = document.getElementById("audio");
                    audio.src = track.preview_url;

                    document.getElementById("playBtn").onclick = async () => {
                        await audio.play();
                        setTimeout(() => { audio.pause(); audio.currentTime = 0; }, MAX_SECONDS * 1000);
                    };
                }
            );
            return;
        } catch (e1) {
            console.warn("facingMode environment failed:", e1);
        }

        try {
            // 2) Fallback: pick any available camera id
            const cams = await Html5Qrcode.getCameras();
            if (!cams || cams.length === 0) {
                alert("Keine Kamera gefunden (Berechtigung?)");
                return;
            }

            await qr.start(
                { deviceId: { exact: cams[0].id } },
                config,
                async (decoded) => {
                    const id = extractId(decoded);
                    if (!id) return;

                    const db = await loadSongs();
                    const track = db[id];
                    if (!track) { alert("Song nicht in songs.json"); return; }

                    document.getElementById("player").style.display = "block";
                    document.getElementById("title").textContent = track.title;
                    document.getElementById("artist").textContent = track.artist;
                    document.getElementById("cover").src = track.cover;

                    const audio = document.getElementById("audio");
                    audio.src = track.preview_url;

                    document.getElementById("playBtn").onclick = async () => {
                        await audio.play();
                        setTimeout(() => { audio.pause(); audio.currentTime = 0; }, MAX_SECONDS * 1000);
                    };
                }
            );
        } catch (e2) {
            console.error("Camera start failed:", e2);
            alert(
                "Kamera konnte nicht gestartet werden.\n\n" +
                "Tipps:\n" +
                "- Seite neu laden und Kamera erlauben\n" +
                "- Andere Tabs/Apps schließen, die die Kamera nutzen\n" +
                "- uBlock/Extensions testweise deaktivieren\n\n" +
                "Fehler: " + (e2?.name || e2)
            );
        }
    }


    document.getElementById("startBtn").onclick = startScanner;
</script>
</body>
</html>


